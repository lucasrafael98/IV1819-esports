<!DOCTYPE html>
<meta charset="utf-8">
<style>

svg {
  font: 10px sans-serif;
}


.bar {
  fill: steelblue;
  clip-path: url(#clip);
}
  
.subBar { 
  fill: gray;
  opacity: 0.5;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.brush .extent {
  stroke: #fff;
  fill: steelblue;
  fill-opacity: .25;
  shape-rendering: crispEdges;
}

  rect.mover {
            stroke: red;
            stroke-opacity: .1;
            fill: lightSteelBlue;
            fill-opacity: .5;
        }
</style>
<body>
<script src="../d3/d3.v5.min.js"></script>
<script>
let teams_sorted;

d3.json("../../teams_sorted.json").then(function (data) {
    data.teams.forEach(element => {
        element.TeamId = +element.TeamId;
        element.TotalUSDPrize = +element.TotalUSDPrize;
        element.TotalTournaments = +element.TotalTournaments;
    });
    teams_sorted = data.teams;
    gen_vis();
});
                    
function gen_vis(){
var margin =  {top: 20, right: 10, bottom: 20, left: 100};
var marginOverview = {top: 30, right: 10, bottom: 20, left: 40};
var selectorHeight = 40;
var width = 1000 - margin.left - margin.right;
var height = 400 - margin.top - margin.bottom - selectorHeight;
var heightOverview = 80 - marginOverview.top - marginOverview.bottom;
       
var maxLength = d3.max(teams_sorted.map(function(d){ return d.TeamName.length}))
var barWidth = maxLength * 3;
var numBars = Math.round(width/barWidth);
var isScrollDisplayed = barWidth * teams_sorted.length > width;
       

console.log(isScrollDisplayed)
  
var xscale = d3.scaleBand()
                .domain(teams_sorted.slice(0,numBars).map(function (d) { return d.TeamName; }))
                .rangeRound([0, width]).paddingInner([0.5]);

var yscale = d3.scaleLinear()
							.domain([0, d3.max(teams_sorted, function (d) { return d.TotalUSDPrize; })])
              .range([height, 0]);
  
var xAxis  = d3.axisBottom().scale(xscale);
var yAxis  = d3.axisLeft().scale(yscale);
  
var svg = d3.select("body").append("svg")
						.attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom + selectorHeight);
  
var diagram = svg.append("g")
								 .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  
diagram.append("g")
  		 .attr("class", "x axis")
       .attr("transform", "translate(0, " + height + ")")
       .call(xAxis);
  
diagram.append("g")
       .attr("class", "y axis")
       .call(yAxis);
  
var bars = diagram.append("g");
  
bars.selectAll("rect")
            .data(teams_sorted.slice(0, numBars), function (d) {return d.TeamName; })
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function (d) { return xscale(d.TeamName); })
            .attr("y", function (d) { return yscale(d.TotalUSDPrize); })
            .attr("width", xscale.bandwidth())
            .attr("height", function (d) { return height - yscale(d.TotalUSDPrize); });

  
if (isScrollDisplayed)
{
  var xOverview = d3.scaleBand()
                  .domain(teams_sorted.map(function (d) { return d.TeamName; }))
                  .rangeRound([0, width]);
  yOverview = d3.scaleLinear().range([heightOverview, 0]);
  yOverview.domain(yscale.domain());

  var subBars = diagram.selectAll('.subBar')
      .data(teams_sorted)
  subBars.enter().append("rect")
      .classed('subBar', true)
      .attr({
          height: function(d) {
              return heightOverview - yOverview(d.TotalUSDPrize);
          },
          width: function(d) {
              return xOverview.bandwidth();
          },
          x: function(d) {
              return xOverview(d.TeamName);
          },
          y: function(d) {
              return height + heightOverview + yOverview(d.TotalUSDPrize)
          }
      })

  var displayed = d3.scaleQuantize()
              .domain([0, width])
              .range(d3.range(teams_sorted.length));

  diagram.append("rect")
              .attr("transform", "translate(0, " + (height + margin.bottom) + ")")
              .attr("class", "mover")
              .attr("x", 0)
              .attr("y", 0)
              .attr("height", selectorHeight)
              .attr("width", Math.round(parseFloat(numBars * width)/teams_sorted.length))
              .attr("pointer-events", "all")
              .attr("cursor", "ew-resize")
              .call(d3.drag().on("drag", display));
}
function display () {
    var x = parseInt(d3.select(this).attr("x")),
        nx = x + d3.event.dx,
        w = parseInt(d3.select(this).attr("width")),
        f, nf, new_data, rects;

    if ( nx < 0 || nx + w > width ) return;

    d3.select(this).attr("x", nx);

    f = displayed(x);
    nf = displayed(nx);

    if ( f === nf ) return;

    new_data = teams_sorted.slice(nf, nf + numBars);

    xscale.domain(new_data.map(function (d) { return d.TeamName; }));
    diagram.select(".x.axis").call(xAxis);

    rects = bars.selectAll("rect")
      .data(new_data, function (d) {return d.TeamName; });

	 	rects.attr("x", function (d) { return xscale(d.TeamName); });

// 	  rects.attr("transform", function(d) { return "translate(" + xscale(d.TeamName) + ",0)"; })

    rects.enter().append("rect")
      .attr("class", "bar")
      .attr("x", function (d) { return xscale(d.TeamName); })
      .attr("y", function (d) { return yscale(d.TotalUSDPrize); })
      .attr("width", xscale.bandwidth())
      .attr("height", function (d) { return height - yscale(d.TotalUSDPrize); });

    rects.exit().remove();
};
}

</script>